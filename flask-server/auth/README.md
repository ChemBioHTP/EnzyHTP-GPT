# Authentication Module.

Author: Zhong, Yinjie.  
Email: yinjie.zhong@vanderbilt.edu

[TOC]

## 1. Introduction

This component serves as a basic authentication for EnzyHTP Webapp.

This component provides following methods.

- `register`: New User Registration.
- `unregister`: Unregister a Current User. Only the user him/herself is permitted to do so.
- `login`: User Login and create a cookie.
- `logout`: User Logout and delete the cookie.
- `profile`: The profile of the user.
- `password/change`: Change the password of the user him/herself.
- `password/reset`: Reset the password of the user him/herself.
- `oauth/unsafe/login`: Test if the application works properly after passing the social login.
- `oauth/<oauth_vendor>/login`: Perform Social Login with OAuth vendors (e.g. Google, Microsoft, etc.)

The `url_prefix` of this component is `'/api/auth'`.

### 1.1 Functions under construction

Some functions should have their routers to be commented in production mode so as to get deactivated since they are not completed or unsafe.

 Function                        | Router                                                                        | Detail
 ------------------------------- | ----------------------------------------------------------------------------- | --------------------
 `password_reset()`              | `@auth.route('/password/reset', methods=['POST, PUT'])`.                      | [Reset Password](#342-reset-password-not-completed)
 `oauth_login_unsafe()`          | `@auth.route('oauth/unsafe/login', methods=['POST'])`.                        | [OAuth Unsafe Login](#351-oauth-unsafe-login)
 `oauth_vendor_login_callback()` | `@auth.route('oauth/<oauth_vendor>/login/callback', methods=['GET', 'POST'])` | [OAuth Vendor Login](#3522-what-to-do)

## 2. Database

The table in the database for `auth` is named `users` and `oauth_users`, which is defined as follows in the `models.py` file located in the current directory.

```python
class User(db.Model, UserMixin):
    
    """User Model: User Information.

    Attributes:
        id (str): Identity generated by UUID4.
        email (str): Email address of the user.
        password (str): Password hashed with SHA256.
        registered_on (datetime): The time when the user is registered.
        admin (bool): The flag showing if the user is an admin.
    """
    __tablename__ = "users"
    id = db.Column(db.String(36), primary_key=True, unique=True)
    email = db.Column(db.String(255), nullable=False, unique=True)
    password = db.Column(db.String(64), nullable=False)
    registered_on = db.Column(db.DateTime, nullable=False)
    admin = db.Column(db.Boolean, nullable=False, default=False)

    ...

class OAuthUser(db.Model):
    """User from Social Login.
    
    Attributes:
        id (str): OAuth Account ID generated by UUID4.
        email (str): Email address of the oauth user.
        oauth_vendor (str): OAuth Vendor, e.g. Google, Microsoft, etc.
        registered_on (datetime): The time when the user is registered.
        user_id: The user ID (of `users` table) to which it is bound.

    """
    __tablename__ = "oauth_users"
    id = db.Column(db.String(36), primary_key=True, unique=True)
    email = db.Column(db.String(255), nullable=False, unique=True)
    oauth_vendor = db.Column(db.String(64), nullable=False)
    registered_on = db.Column(db.DateTime, nullable=False)
    user_id = db.Column(db.String(36), db.ForeignKey('users.id'), nullable=True)
    user = db.relationship('User', backref=db.backref('oauth_users'))

    ...
```

The sqlite database will be generated as `/flask-server/instance/enzyhtp-gpt.db` the first time we run the `server.py` if no existing database file in the folder.

Shut down the server, change the directory to the `/flask-server` directory, and run `python instance/init_db.py`. Then, some example fake data will be added to the `users` table of the sqlite database.

## 3. Functions

Here, we use the account `maura.attaway@example.com` for instance to show its function, which is an account generated randomly.

### 3.1 Register and Unregister

#### 3.1.1 Register

- Path: `/api/auth/register`.
- Request Method: `POST`.
- Request Body: `form-data`.
  - `email`: Your email address.
  - `password`: Password set.
- Returns:
  - If succeeded,
    - Status Code: `201 CREATED`.
    - Response Body (example)
    ```json
    {
        "id": "b701ff89-84db-44e3-8ed6-bb973efbebcf",
        "email": "maura.attaway@example.com",
        "is_successful": true,
        "message": "New user `maura.attaway@example.com` is created.",
        "timestamp": "2023-10-30 13:21:55.286660",
        "is_authenticated": false
    }
    ```
  - If failed (due to conflict),
    - Status Code: `400 BAD REQUEST`.
    - Response Body: 
    ```json
    {
        "id": null,
        "email": "maura.attaway@example.com",
        "is_successful": false,
        "message": "New user `maura.attaway@example.com` conflicted with an existing account.",
        "timestamp": "2023-10-30 20:08:36.306698",
        "is_authenticated": false
    }
    ```

#### 3.1.2 Unregister

- Path: `/api/auth/unregister`.
- Request Method: `POST` | `DELETE`.
- Request Body:
  - `email`: The email address of the user to unregister.
- Returns:
  - If succeeded,
    - Status: `200 OK`.
    - Response Body:
    ```json
    {
        "id": "b701ff89-84db-44e3-8ed6-bb973efbebcf",
        "email": "maura.attaway@example.com",
        "is_successful": true,
        "message": "User `maura.attaway@example.com` is unregistered.",
        "timestamp": "2023-10-30 21:44:47.618434",
        "is_authenticated": false
    }
    ```
    - P.s. Cookie is deleted upon this response.
  - If failed (because user didn't log in).
    - Status: `401 UNAUTHORIZED`.
    - Response Body:
    ```json
    {
        "id": null,
        "email": null,
        "is_successful": false,
        "message": "Unauthorized request, please login first.",
        "timestamp": "2023-10-30 21:09:22.485493",
        "is_authenticated": false
    }
    ```
  - If failed (because user does not exist).
    - Status: `403 FORBIDDEN`.
    - Response Body:
    ```json
    {
        "id": "1bce4b77-9c60-4144-a907-c46aa1258722",
        "email": "maura.attaway@example.com",
        "is_successful": false,
        "message": "Target user `maua.attaway@example.com` does not exist.",
        "timestamp": "2023-10-30 22:15:18.917277",
        "is_authenticated": true
    }
    ```
  - If failed (because user is not permitted to delete other user).
    - Status: `403 FORBIDDEN`.
    - Response Body:
    ```json
    {
        "id": "017663b8-0bde-4032-84f0-66f7284afeaf",
        "email": "maura.attaway@example.com",
        "is_successful": false,
        "message": "You cannot unregister `tom.white@example.com`.",
        "timestamp": "2023-10-30 21:58:30.902273",
        "is_authenticated": true
    } 
    ```

### 3.2 Login and Logout

#### 3.2.1 Login

- Path: `/api/auth/login`.
- Request Method: `POST`.
- Request Body: `form-data`.
  - `email`: Your email address.
  - `password`: Password set.
  - `remember`: Whether to remember the user(s) after the browser(s) is closed. Defaults to `False`.
- Returns:
  - If succeeded,
    - Status Code: `200 OK`.
    - Response Body (example)
    ```json
    {
        "id": "637f25c8-c7b8-4182-997a-6fd53e346ecf",
        "email": "maura.attaway@example.com",
        "is_successful": true,
        "message": "The user `maura.attaway@example.com` logged in.",
        "timestamp": "2023-10-30 18:04:49.150020",
        "is_authenticated": true
    }
    ```
  - If failed (due to conflict),
    - Status Code: `401 UNAUTHORIZED`.
    - Response Body: 
    ```json
    {
        "id": null,
        "email": "maura.attaway@example.com",
        "is_successful": true,
        "message": "The user `maura.attaway@example.com` failed to log in.",
        "timestamp": "2023-10-30 20:08:17.820156",
        "is_authenticated": false
    }
    ```

#### 3.2.2 Logout

- Path: `/api/auth/logout`.
- Request Method: `GET` | `POST`.
- Request body: Not required.
- Returns:
  - If succeeded,
    - Status Code: `200 OK`.
    - Response Body (example)
    ```json
    {
        "id": "b701ff89-84db-44e3-8ed6-bb973efbebcf",
        "email": "maura.attaway@example.com",
        "is_successful": true,
        "message": "The user `maura.attaway@example.com` logged out.",
        "timestamp": "2023-10-30 20:08:17.820156",
        "is_authenticated": false
    }
    ```
  - If failed (because user didn't log in).
    - Status Code: `401 UNAUTHORIZED`.
    - Response Body: 
    ```json
    {
        "id": null,
        "email": null,
        "is_successful": false,
        "message": "Unauthorized request, please login first.",
        "timestamp": "2023-10-30 21:09:22.485493",
        "is_authenticated": false
    }
    ```



### 3.3 Profile

#### 3.3.1 Profile Index

- Path: `/api/auth/profile`.
- Request Method: `GET` | `POST`.
- Request Body: Not required.
- Returns:
  - If succeeded,
    - Status: `200 OK`.
    - Response Body:
    ```json
    {
        "id": "b701ff89-84db-44e3-8ed6-bb973efbebcf",
        "email": "maura.attaway@example.com",
        "is_successful": true,
        "message": "",
        "timestamp": "2023-10-30 20:08:17.820156",
        "is_authenticated": true
    }
    ```
  - If failed (happen when the user is not authenticated.)
    - Status Code: `401 UNAUTHORIZED`.
    - Response Body: 
    ```json
    {
        "id": null,
        "email": null,
        "is_successful": false,
        "message": "Unauthorized request, please login first.",
        "timestamp": "2023-10-30 20:08:17.820156",
        "is_authenticated": false
    }
    ```

### 3.4 Password

#### 3.4.1 Change Password

- Path: `/api/auth/password/change`.
- Request Method: `POST` | `PUT`.
- Request Body: `form-data`.
  - `old_password`: Your old password.
  - `new_password`: Your new password.
- Returns:
  - If succeeded,
    - Status: `200 OK`.
    - Response Body:
    ```json
    {
        "id": "1bce4b77-9c60-4144-a907-c46aa1258722",
        "email": "maura.attaway@example.com",
        "is_successful": true,
        "message": "User `maura.attaway@example.com` succeeded to change the password.",
        "timestamp": "2023-10-31 01:07:52.281764",
        "is_authenticated": true
    }
    ```
  - If failed (because the old password does not match.)
    - Status Code: `400 BAD REQUEST`.
    - Response Body: 
    ```json
    {
        "id": "1bce4b77-9c60-4144-a907-c46aa1258722",
        "email": "maura.attaway@example.com",
        "is_successful": false,
        "message": "User `maura.attaway@example.com` failed to change the password due to unmatched old password.",
        "timestamp": "2023-10-31 01:07:52.281764",
        "is_authenticated": true
    }
    ```
  - If failed (happen when the user is not authenticated.)
    - Status Code: `401 UNAUTHORIZED`.
    - Response Body: 
    ```json
    {
        "id": null,
        "email": null,
        "is_successful": false,
        "message": "Unauthorized request, please login first.",
        "timestamp": "2023-10-30 20:08:17.820156",
        "is_authenticated": false
    }
    ```

#### 3.4.2 Reset Password (Not completed)

Function when people forget their password, or a new user logs in using Social Login.
**TODO**: (Yinjie) send recovery code via email using SMTP. We need something like noreply@domain.com mailbox.

- Path: `/api/auth/password/reset`.
- Request Method: `POST` | `PUT`.
- Request Body: Not required.
- Returns: (Leave for later...)

### 3.5 OAuth

#### 3.5.1 OAuth Unsafe Login

This method is only to test if the application works properly after passing the social login.
This method is for development mode only.
This method cannot be used in production mode, where its router should be commented.
Thus, this method will always respond with `200 OK` (with right input).

- Path: `/api/auth/oauth/unsafe/login`.
- Request Method: `POST`.
- Request Body: `form-data`.
  - `email`: Email address of the oauth user.
  - `oauth_vendor`: OAuth Vendor, e.g. Google, Microsoft, etc. (In this function, whatever `oauth_vendor` fields will eventually be recorded as `Unsafe` in the database.)
  - `username`: The username of the account from OAuth Vendor.
  - `remember`: Whether to remember the user(s) after the browser(s) is closed. Defaults to `False`.
- Returns:
  - If account exists, match.
    - Status Code: `200 OK`.
    - Response Body
    ```json
    {
      "id": "0859579b-234d-4b03-8b56-552552c37230",
      "email": "lisa.green@example.com",
      "username": "lisa.green",
      "is_successful": true,
      "message": "User `lisa.green` logged in using `Unsafe` account.",
      "timestamp": "2023-12-12 21:48:22.255380",
      "is_authenticated": true,
      "oauth_email": "lisa.green@example.com",
      "oauth_vendor": "Unsafe"
    }
    ```
  - If social login account is identical with existing user's, bind.
    - Status Code: `201 CREATED`.
    - Response Body: 
    ```json
    {
        "id": "d3bfa780-377d-4f33-ab62-49fdbd0648a1",
        "email": "san.zhang@example.com",
        "username": "ZHANG San",
        "is_successful": true,
        "message": "`New oauth account `san.zhang@example.com` logged in using `Unsafe` account, automatically bound to User `ZHANG San`.",
        "timestamp": "2023-12-13 22:32:17.976542",
        "is_authenticated": true,
        "oauth_email": "san.zhang@example.com",
        "oauth_vendor": "Unsafe"
    }
    ```
  - If social login email doesn't exist in the `users` table, create new user.
    - Status Code: `201 CREATED`.
    - Response Body: 
    ```json
    {
        "id": "d3bfa780-377d-4f33-ab62-49fdbd0648a1",
        "email": "san.zhang@example.com",
        "username": "ZHANG San",
        "is_successful": true,
        "message": "`New oauth account `san.zhang@example.com` logged in using `Unsafe` account. Create new User `ZHANG San`.",
        "timestamp": "2023-12-12 22:03:40.414137",
        "is_authenticated": true,
        "oauth_email": "san.zhang@example.com",
        "oauth_vendor": "Unsafe"
    }
    ```

#### 3.5.2 OAuth Vendor Login

This method is to redirect the user to the Social Login consent page (i.e., Google, Microsoft, etc.) and automatically redirect to the callback function to grab the user information from the vendor's. Then, the login process will be performed by the EnzyHTP Web Application to set up a session and grant user with the cookie. 

Vendor login consists of 2 functions: `oauth_vendor_login()` and `oauth_vendor_login_callback()`.

 Function                      | Path                                          | Method     | Description
 ----------------------------- | --------------------------------------------- | ---------- | ------
 oauth_vendor_login()          | /api/auth/oauth/<oauth_vendor>/login          | GET / POST | OAuth Login Uri
 oauth_vendor_login_callback() | /api/auth/oauth/<oauth_vendor>/login/callback | GET / POST | OAuth Login Callback Function

Here, the `oauth_vendor` is a variable. For example, if we are to login with Google, the path would be: `/api/auth/oauth/google/login`.

Before developing or testing OAuth, some preparations should be done. Please check the `README.md` file in the `/flask-server` directory or Click the Links: 1. [SSL Certificates](../README.md#3-ssl-certificates) 2. [OAuth Clients](../README.md#4-oauth-clients).

##### 3.5.2.1 How it works?

- For the convenience of description, Google Login is employed for instance.
- When the user click the Social Login button (e.g. Login with Google), navigate the user to `https://<HOST_DOMAIN>:<PORT>/api/auth/oauth/google/login`, which will be automatically redirected (Status: 302) to the consent page of Google.
- After the user confirmed the consent with Google, the Callback Function functions to grab the user information from Google with the authorization code.
- Then, the EnzyHTP Web Application will perform login process with the information from Google, and send returns in `application/json` format.
  - If account exist, match.
    - Status Code: `200 OK`.
    - Response Body
    ```json
    {
        "id": "ded2aacd-70a2-491e-9446-331526bd9f8a",
        "email": "yinjie.zhong.cn@gmail.com",
        "username": "Yinjie",
        "is_successful": true,
        "message": "User `Yinjie` logged in using `Google` account.",
        "timestamp": "2023-12-14 03:52:19.522954",
        "is_authenticated": true,
        "oauth_email": "yinjie.zhong.cn@gmail.com",
        "oauth_vendor": "Google"
    }
    ```
  - If social login account is identical with existing user's, bind.
    - Status Code: `201 CREATED`.
    - Response Body: 
    ```json
    {
        "id": "ded2aacd-70a2-491e-9446-331526bd9f8a",
        "email": "yinjie.zhong.cn@gmail.com",
        "username": "Yinjie",
        "is_successful": true,
        "message": "`New oauth account `yinjie.zhong.cn@gmail.com` logged in using `Google` account, automatically bound to User `Yinjie`.",
        "timestamp": "2023-12-14 03:48:07.729680",
        "is_authenticated": true,
        "oauth_email": "yinjie.zhong.cn@gmail.com",
        "oauth_vendor": "Google"
    }
    ```
  - If social login email doesn't exist in the `users` table, create new user.
    - Status Code: `201 CREATED`.
    - Response Body: 
    ```json
    {
        "id": "2e76933b-1bf0-43da-b02c-209d1c5c66bb",
        "email": "yinjie.zhong.cn@gmail.com",
        "username": "Yinjie Zhong",
        "is_successful": true,
        "message": "`New oauth account `yinjie.zhong.cn@gmail.com` logged in using `Google` account. Create new User `Yinjie Zhong`.",
        "timestamp": "2023-12-14 04:21:32.808972",
        "is_authenticated": true,
        "oauth_email": "yinjie.zhong.cn@gmail.com",
        "oauth_vendor": "Google"
    }
    ```

##### 3.5.2.2 What to do?

- Current callback function is imperfect, since it's so weird to let user(s) see some json strings.
- It's better to have a dashboard or homepage for user to redirect to. Then, a redirect(301) response can be sent to redirect users to that page.
- Since the login process is completed before the redirect(301) response is sent, thus, the user will receive a cookie together with the response (i.e. User session has been established by then).
