# Authentication Module.

Author: Zhong, Yinjie.
Email: yinjie.zhong@vanderbilt.edu

[TOC]

## 1. Introduction

This component serves as a basic authentication for EnzyHTP Webapp.

This component provides following methods.

- `register`: New User Registration.
- `unregister`: Unregister a Current User. Only the user him/herself is permitted to do so.
- `login`: User Login and create a cookie.
- `logout`: User Logout and delete the cookie.
- `profile`: The profile of the user.
- `change-password`: Change the password of the user he/sheself.

The `url_prefix` of this component is `'/api/auth'`.

## 2. Database

The table in the database for `auth` is named `users`, which is defined as follows in the `models.py` file located in the current directory.

```python
class User(db.Model, UserMixin):
    
    """User Model: User Information.

    Attributes:
        id (str): Identity generated by UUID4.
        email (str): Email address of the user.
        password (str): Password hashed with SHA256.
        registered_on (datetime): The time when the user is registered.
        admin (bool): The flag showing if the user is an admin.
    """
    __tablename__ = "users"
    id = db.Column(db.String(36), primary_key=True, unique=True)
    email = db.Column(db.String(255), nullable=False, unique=True)
    password = db.Column(db.String(64), nullable=False)
    registered_on = db.Column(db.DateTime, nullable=False)
    admin = db.Column(db.Boolean, nullable=False, default=False)

    ...
```

## 3. Methods

Here, we use the account `maura.attaway@example.com` for instance to show its function, which is an account generated randomly.

### 3.1 Register

- Path: `/api/auth/register`.
- Request Method: `POST`.
- Request Body: `form-data`.
  - `email`: Your email address.
  - `password`: Password set.
- Returns:
  - If succeeded,
    - Status Code: `201 CREATED`.
    - Response Body (example)
    ```json
    {
        "id": "b701ff89-84db-44e3-8ed6-bb973efbebcf",
        "email": "maura.attaway@example.com",
        "is_successful": true,
        "message": "New user `maura.attaway@example.com` is created.",
        "timestamp": "2023-10-30 13:21:55.286660",
        "is_authenticated": false
    }
    ```
  - If failed (due to conflict),
    - Status Code: `400 BAD REQUEST`.
    - Response Body: 
    ```json
    {
        "id": null,
        "email": "maura.attaway@example.com",
        "is_successful": false,
        "message": "New user `maura.attaway@example.com` conflicted with an existing account.",
        "timestamp": "2023-10-30 20:08:36.306698",
        "is_authenticated": false
    }
    ```

### 3.2 Login

- Path: `/api/auth/login`.
- Request Method: `POST`.
- Request Body: `form-data`.
  - `email`: Your email address.
  - `password`: Password set.
- Returns:
  - If succeeded,
    - Status Code: `200 OK`.
    - Response Body (example)
    ```json
    {
        "id": "637f25c8-c7b8-4182-997a-6fd53e346ecf",
        "email": "maura.attaway@example.com",
        "is_successful": true,
        "message": "The user `maura.attaway@example.com` logged in.",
        "timestamp": "2023-10-30 18:04:49.150020",
        "is_authenticated": true
    }
    ```
  - If failed (due to conflict),
    - Status Code: `401 UNAUTHORIZED`.
    - Response Body: 
    ```json
    {
        "id": null,
        "email": "maura.attaway@example.com",
        "is_successful": true,
        "message": "The user `maura.attaway@example.com` failed to log in.",
        "timestamp": "2023-10-30 20:08:17.820156",
        "is_authenticated": false
    }
    ```

### 3.3 Logout

- Path: `/api/auth/logout`.
- Request Method: `GET` | `POST`.
- Request body: Not required.
- Returns:
  - If succeeded,
    - Status Code: `200 OK`.
    - Response Body (example)
    ```json
    {
        "id": "b701ff89-84db-44e3-8ed6-bb973efbebcf",
        "email": "maura.attaway@example.com",
        "is_successful": true,
        "message": "The user `maura.attaway@example.com` logged out.",
        "timestamp": "2023-10-30 20:08:17.820156",
        "is_authenticated": false
    }
    ```
  - If failed (because user didn't log in).
    - Status Code: `401 UNAUTHORIZED`.
    - Response Body: 
    ```json
    {
        "id": null,
        "email": null,
        "is_successful": false,
        "message": "Unauthorized request, please login first.",
        "timestamp": "2023-10-30 21:09:22.485493",
        "is_authenticated": false
    }
    ```
### 3.4 Unregister

- Path: `/api/auth/profile`.
- Request Method: `POST` | `DELETE`.
- Request Body:
  - `email`: The email address of the user to unregister.
- Returns:
  - If succeeded,
    - Status: `200 OK`.
    - Response Body:
    ```json
    {
        "id": "b701ff89-84db-44e3-8ed6-bb973efbebcf",
        "email": "maura.attaway@example.com",
        "is_successful": true,
        "message": "User `maura.attaway@example.com` is unregistered.",
        "timestamp": "2023-10-30 21:44:47.618434",
        "is_authenticated": false
    }
    ```
    - P.s. Cookie is deleted upon this response.
  - If failed (because user didn't log in).
    - Status: `401 UNAUTHORIZED`.
    - Response Body:
    ```json
    {
        "id": null,
        "email": null,
        "is_successful": false,
        "message": "Unauthorized request, please login first.",
        "timestamp": "2023-10-30 21:09:22.485493",
        "is_authenticated": false
    }
    ```
  - If failed (because user does not exist).
    - Status: `403 FORBIDDEN`.
    - Response Body:
    ```json
    {
        "id": "1bce4b77-9c60-4144-a907-c46aa1258722",
        "email": "maura.attaway@example.com",
        "is_successful": false,
        "message": "Target user `maua.attaway@example.com` does not exist.",
        "timestamp": "2023-10-30 22:15:18.917277",
        "is_authenticated": true
    }
    ```
  - If failed (because user is not permitted to delete other user).
    - Status: `403 FORBIDDEN`.
    - Response Body:
    ```json
    {
        "id": "017663b8-0bde-4032-84f0-66f7284afeaf",
        "email": "maura.attaway@example.com",
        "is_successful": false,
        "message": "You cannot unregister `tom.white@example.com`.",
        "timestamp": "2023-10-30 21:58:30.902273",
        "is_authenticated": true
    } 
    ```

### 3.5 Profile

- Path: `/api/auth/profile`.
- Request Method: `GET` | `POST`.
- Request Body: Not required.
- Returns:
  - If succeeded,
    - Status: `200 OK`.
    - Response Body:
    ```json
    {
        "id": "b701ff89-84db-44e3-8ed6-bb973efbebcf",
        "email": "maura.attaway@example.com",
        "is_successful": true,
        "message": "",
        "timestamp": "2023-10-30 20:08:17.820156",
        "is_authenticated": true
    }
    ```
  - If failed (happen when the user is not authenticated.)
    - Status Code: `401 UNAUTHORIZED`.
    - Response Body: 
    ```json
    {
        "id": null,
        "email": null,
        "is_successful": false,
        "message": "Unauthorized request, please login first.",
        "timestamp": "2023-10-30 20:08:17.820156",
        "is_authenticated": false
    }
    ```

### 3.6 Change Password

- Path: `/api/auth/change-password`.
- Request Method: `POST` | `PUT`.
- Request Body: Not required.
- Returns:
  - If succeeded,
    - Status: `200 OK`.
    - Response Body:
    ```json
    {
        "id": "1bce4b77-9c60-4144-a907-c46aa1258722",
        "email": "maura.attaway@example.com",
        "is_successful": true,
        "message": "User `maura.attaway@example.com` succeeded to change the password.",
        "timestamp": "2023-10-31 01:07:52.281764",
        "is_authenticated": true
    }
    ```
  - If failed (because the old password does not match.)
    - Status Code: `400 BAD REQUEST`.
    - Response Body: 
    ```json
    {
        "id": "1bce4b77-9c60-4144-a907-c46aa1258722",
        "email": "maura.attaway@example.com",
        "is_successful": false,
        "message": "User `maura.attaway@example.com` failed to change the password due to unmatched old password.",
        "timestamp": "2023-10-31 01:07:52.281764",
        "is_authenticated": true
    }
    ```
  - If failed (happen when the user is not authenticated.)
    - Status Code: `401 UNAUTHORIZED`.
    - Response Body: 
    ```json
    {
        "id": null,
        "email": null,
        "is_successful": false,
        "message": "Unauthorized request, please login first.",
        "timestamp": "2023-10-30 20:08:17.820156",
        "is_authenticated": false
    }
    ```
